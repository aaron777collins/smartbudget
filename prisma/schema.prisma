// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String         @id @default(uuid())
  username             String         @unique
  email                String?        @unique
  name                 String?
  password             String
  emailVerified        DateTime?
  image                String?
  failedLoginAttempts  Int            @default(0)
  accountLockedUntil   DateTime?
  lastFailedLoginAt    DateTime?
  lastActivityAt       DateTime?      // Track last user activity for inactivity detection
  sessionCreatedAt     DateTime?      // When current session was created
  accounts             Account[]
  transactions         Transaction[]
  budgets              Budget[]
  goals                Goal[]
  categories           Category[]
  tags                 Tag[]
  settings             UserSettings?
  filterPresets        FilterPreset[]
  jobs                 Job[]
  feedback             Feedback[]
  refreshTokens        RefreshToken[]
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}

model Account {
  id               String        @id @default(uuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  institution      String
  accountType      AccountType
  accountNumber    String?
  currency         String        @default("CAD")
  currentBalance   Decimal       @db.Decimal(19, 4)
  availableBalance Decimal?      @db.Decimal(19, 4)
  color            String        @default("#2563EB")
  icon             String        @default("wallet")
  isActive         Boolean       @default(true)
  transactions     Transaction[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([userId, institution, accountNumber])
}

model Transaction {
  id              String             @id @default(uuid())
  accountId       String
  account         Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime
  postedDate      DateTime?
  description     String
  merchantName    String
  amount          Decimal            @db.Decimal(19, 4)
  type            TransactionType
  categoryId      String?
  category        Category?          @relation(fields: [categoryId], references: [id])
  subcategoryId   String?
  subcategory     Subcategory?       @relation(fields: [subcategoryId], references: [id])
  tags            Tag[]
  notes           String?
  fitid           String?            @unique
  isReconciled    Boolean            @default(false)
  isRecurring     Boolean            @default(false)
  recurringRuleId String?
  recurringRule   RecurringRule?     @relation(fields: [recurringRuleId], references: [id])
  confidenceScore Float?
  userCorrected   Boolean            @default(false)
  rawData         Json?
  splits          TransactionSplit[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
  @@index([merchantName])
  @@index([categoryId])
  @@index([userId, categoryId, date])
  @@index([userId, type, date])
  @@index([userId, type, categoryId, date])
}

model Category {
  id               String           @id @default(uuid())
  name             String
  slug             String           @unique
  icon             String
  color            String
  description      String?
  parentId         String?
  parent           Category?        @relation("CategoryTree", fields: [parentId], references: [id])
  subcategories    Category[]       @relation("CategoryTree")
  transactions     Transaction[]
  budgets          BudgetCategory[]
  isSystemCategory Boolean          @default(true)
  userId           String?
  user             User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([parentId])
}

model Subcategory {
  id           String        @id @default(uuid())
  categoryId   String
  name         String
  slug         String        @unique
  icon         String?
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Budget {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  type        BudgetType
  period      BudgetPeriod
  startDate   DateTime
  endDate     DateTime?
  totalAmount Decimal          @db.Decimal(19, 4)
  categories  BudgetCategory[]
  isActive    Boolean          @default(true)
  rollover    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model BudgetCategory {
  id         String   @id @default(uuid())
  budgetId   String
  budget     Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  amount     Decimal  @db.Decimal(19, 4)
  spent      Decimal  @default(0) @db.Decimal(19, 4)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([budgetId, categoryId])
}

model Goal {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  type          GoalType
  targetAmount  Decimal   @db.Decimal(19, 4)
  currentAmount Decimal   @default(0) @db.Decimal(19, 4)
  targetDate    DateTime?
  isCompleted   Boolean   @default(false)
  icon          String?
  color         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model RecurringRule {
  id           String        @id @default(uuid())
  merchantName String
  frequency    Frequency
  amount       Decimal       @db.Decimal(19, 4)
  categoryId   String
  nextDueDate  DateTime
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Tag {
  id           String        @id @default(uuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  color        String        @default("#6B7280")
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([userId, name])
}

model TransactionSplit {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  categoryId    String
  amount        Decimal     @db.Decimal(19, 4)
  percentage    Decimal?    @db.Decimal(5, 2)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model MerchantKnowledge {
  id              String   @id @default(uuid())
  merchantName    String   @unique
  normalizedName  String
  categoryId      String
  confidenceScore Float
  source          String // "rule", "ml", "claude_ai", "user"
  metadata        Json? // Store additional info from Claude AI research
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([normalizedName])
}

model UserSettings {
  id                     String   @id @default(uuid())
  userId                 String   @unique
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency               String   @default("CAD")
  dateFormat             String   @default("MM/DD/YYYY")
  firstDayOfWeek         Int      @default(0) // 0 = Sunday
  theme                  String   @default("system")
  notificationsEnabled   Boolean  @default(true)
  emailDigest            Boolean  @default(true)
  digestFrequency        String   @default("weekly")
  budgetAlertThreshold   Int      @default(80) // percentage
  hasCompletedOnboarding Boolean  @default(false)
  onboardingStep         Int      @default(0) // Current step in onboarding (0-4)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model FilterPreset {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  filters   Json // Stores filter configuration
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  LOAN
  OTHER
}

enum TransactionType {
  DEBIT
  CREDIT
  TRANSFER
}

enum BudgetType {
  ENVELOPE
  PERCENTAGE
  FIXED_AMOUNT
  GOAL_BASED
}

enum BudgetPeriod {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum GoalType {
  SAVINGS
  DEBT_PAYOFF
  NET_WORTH
  INVESTMENT
}

enum Frequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model Job {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        JobType
  status      JobStatus @default(PENDING)
  progress    Int       @default(0) // Percentage 0-100
  total       Int? // Total items to process
  processed   Int       @default(0) // Items processed so far
  payload     Json // Job-specific data (merchants, parameters, etc.)
  result      Json? // Job result data
  error       String? // Error message if failed
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, status])
  @@index([status, createdAt])
}

enum JobType {
  MERCHANT_RESEARCH_BATCH
  TRANSACTION_CATEGORIZE_BATCH
  IMPORT_TRANSACTIONS
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model Feedback {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              FeedbackType
  priority          FeedbackPriority
  title             String
  description       String         @db.Text
  stepsToReproduce  String?        @db.Text
  expectedBehavior  String?        @db.Text
  actualBehavior    String?        @db.Text
  browserInfo       Json?
  status            FeedbackStatus @default(NEW)
  resolution        String?        @db.Text
  resolvedAt        DateTime?
  resolvedBy        String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId, status])
  @@index([status, createdAt])
  @@index([type, priority])
}

model AuditLog {
  id          String        @id @default(uuid())
  userId      String?
  action      AuditAction
  entityType  String // "account", "transaction", "budget", etc.
  entityId    String?
  oldValues   Json? // Previous state of the entity
  newValues   Json? // New state of the entity
  ipAddress   String?
  userAgent   String?
  status      AuditStatus   @default(SUCCESS)
  errorMessage String?      @db.Text
  metadata    Json? // Additional context
  createdAt   DateTime      @default(now())

  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@index([action, createdAt])
  @@index([status, createdAt])
}

model SecurityEvent {
  id            String           @id @default(uuid())
  userId        String?
  eventType     SecurityEventType
  severity      SecuritySeverity @default(INFO)
  description   String           @db.Text
  ipAddress     String?
  userAgent     String?
  success       Boolean          @default(true)
  failureReason String?
  metadata      Json? // Additional context
  createdAt     DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@index([success, createdAt])
}

enum FeedbackType {
  BUG
  FEATURE
  IMPROVEMENT
  OTHER
}

enum FeedbackPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FeedbackStatus {
  NEW
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CLOSED
  WONT_FIX
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
  IMPORT
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  EMAIL_CHANGE
  SETTINGS_UPDATE
  PERMISSION_CHANGE
}

enum AuditStatus {
  SUCCESS
  FAILURE
  PARTIAL
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILURE
  LOGOUT
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  EMAIL_CHANGE
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SESSION_EXPIRED
  UNAUTHORIZED_ACCESS_ATTEMPT
  RATE_LIMIT_EXCEEDED
  SUSPICIOUS_ACTIVITY
  DATA_EXPORT
  DATA_DELETION
  PERMISSION_ELEVATION
  MFA_ENABLED
  MFA_DISABLED
  MFA_BACKUP_CODES_GENERATED
}

enum SecuritySeverity {
  LOW
  INFO
  MEDIUM
  HIGH
  CRITICAL
}

model RefreshToken {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token           String   @unique // Hashed refresh token
  tokenFamily     String   // Family identifier for rotation detection
  expiresAt       DateTime // Refresh token expiration (7 days)
  isRevoked       Boolean  @default(false)
  revokedAt       DateTime?
  revokedReason   String? // "logout", "password_change", "token_theft", "manual_revocation"
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime @default(now())

  @@index([userId, isRevoked])
  @@index([tokenFamily, isRevoked])
  @@index([expiresAt])
}
