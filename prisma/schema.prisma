// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  name          String?
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  transactions  Transaction[]
  budgets       Budget[]
  goals         Goal[]
  categories    Category[]
  tags          Tag[]
  settings      UserSettings?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Account {
  id               String        @id @default(uuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  institution      String
  accountType      AccountType
  accountNumber    String?
  currency         String        @default("CAD")
  currentBalance   Decimal       @db.Decimal(19, 4)
  availableBalance Decimal?      @db.Decimal(19, 4)
  color            String        @default("#2563EB")
  icon             String        @default("wallet")
  isActive         Boolean       @default(true)
  transactions     Transaction[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model Transaction {
  id              String             @id @default(uuid())
  accountId       String
  account         Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime
  postedDate      DateTime?
  description     String
  merchantName    String
  amount          Decimal            @db.Decimal(19, 4)
  type            TransactionType
  categoryId      String?
  category        Category?          @relation(fields: [categoryId], references: [id])
  subcategoryId   String?
  subcategory     Subcategory?       @relation(fields: [subcategoryId], references: [id])
  tags            Tag[]
  notes           String?
  fitid           String?            @unique
  isReconciled    Boolean            @default(false)
  isRecurring     Boolean            @default(false)
  recurringRuleId String?
  recurringRule   RecurringRule?     @relation(fields: [recurringRuleId], references: [id])
  confidenceScore Float?
  userCorrected   Boolean            @default(false)
  rawData         Json?
  splits          TransactionSplit[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
  @@index([merchantName])
  @@index([categoryId])
}

model Category {
  id               String           @id @default(uuid())
  name             String
  slug             String           @unique
  icon             String
  color            String
  description      String?
  parentId         String?
  parent           Category?        @relation("CategoryTree", fields: [parentId], references: [id])
  subcategories    Category[]       @relation("CategoryTree")
  transactions     Transaction[]
  budgets          BudgetCategory[]
  isSystemCategory Boolean          @default(true)
  userId           String?
  user             User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
}

model Subcategory {
  id           String        @id @default(uuid())
  categoryId   String
  name         String
  slug         String        @unique
  icon         String?
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Budget {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  type        BudgetType
  period      BudgetPeriod
  startDate   DateTime
  endDate     DateTime?
  totalAmount Decimal          @db.Decimal(19, 4)
  categories  BudgetCategory[]
  isActive    Boolean          @default(true)
  rollover    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model BudgetCategory {
  id         String   @id @default(uuid())
  budgetId   String
  budget     Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  amount     Decimal  @db.Decimal(19, 4)
  spent      Decimal  @default(0) @db.Decimal(19, 4)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([budgetId, categoryId])
}

model Goal {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  type          GoalType
  targetAmount  Decimal   @db.Decimal(19, 4)
  currentAmount Decimal   @default(0) @db.Decimal(19, 4)
  targetDate    DateTime?
  isCompleted   Boolean   @default(false)
  icon          String?
  color         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model RecurringRule {
  id           String        @id @default(uuid())
  merchantName String
  frequency    Frequency
  amount       Decimal       @db.Decimal(19, 4)
  categoryId   String
  nextDueDate  DateTime
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Tag {
  id           String        @id @default(uuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  color        String        @default("#6B7280")
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([userId, name])
}

model TransactionSplit {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  categoryId    String
  amount        Decimal     @db.Decimal(19, 4)
  percentage    Decimal?    @db.Decimal(5, 2)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model MerchantKnowledge {
  id              String   @id @default(uuid())
  merchantName    String   @unique
  normalizedName  String
  categoryId      String
  confidenceScore Float
  source          String // "rule", "ml", "claude_ai", "user"
  metadata        Json?    // Store additional info from Claude AI research
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([normalizedName])
}

model UserSettings {
  id                   String   @id @default(uuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency             String   @default("CAD")
  dateFormat           String   @default("MM/DD/YYYY")
  firstDayOfWeek       Int      @default(0) // 0 = Sunday
  theme                String   @default("system")
  notificationsEnabled Boolean  @default(true)
  emailDigest          Boolean  @default(true)
  digestFrequency      String   @default("weekly")
  budgetAlertThreshold Int      @default(80) // percentage
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  LOAN
  OTHER
}

enum TransactionType {
  DEBIT
  CREDIT
  TRANSFER
}

enum BudgetType {
  ENVELOPE
  PERCENTAGE
  FIXED_AMOUNT
  GOAL_BASED
}

enum BudgetPeriod {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum GoalType {
  SAVINGS
  DEBT_PAYOFF
  NET_WORTH
  INVESTMENT
}

enum Frequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}
